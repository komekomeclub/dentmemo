<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éšå±¤ãƒ¡ãƒ¢</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&display=swap');
  * { box-sizing:border-box; margin:0; padding:0; }
  :root {
    --bg:#f0ebe3; --surface:#e8e2d9; --border:#c8bfb0;
    --text:#3a342c; --text-muted:#8a7d6e; --accent:#b8650a;
    --bullet:#9a8b7a; --row-h:48px; --font-size:24px;
  }
  body { font-family:'Noto Sans JP',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

  .screen { display:none; flex-direction:column; height:100vh; }
  .screen.active { display:flex; }

  .hdr { flex-shrink:0; padding:14px 16px 12px; border-bottom:1px solid var(--border); background:var(--surface); display:flex; align-items:center; justify-content:space-between; }
  .hdr-left { display:flex; align-items:center; gap:10px; }
  .hdr h1 { font-size:17px; font-weight:500; color:var(--text-muted); letter-spacing:.04em; }
  .icon-btn { width:36px; height:36px; border-radius:8px; border:1.5px solid var(--border); background:var(--bg); color:var(--text-muted); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; -webkit-tap-highlight-color:transparent; }
  .icon-btn:active { transform:scale(.9); background:var(--border); }

  /* ä¸€è¦§ */
  #list-body { flex:1; overflow-y:auto; padding:16px 12px; }
  #list-footer { flex-shrink:0; background:var(--surface); border-top:1px solid var(--border); padding:12px 20px; display:flex; align-items:center; justify-content:center; }
  #btn-new { display:flex; align-items:center; gap:8px; padding:13px 32px; border-radius:12px; border:none; background:var(--accent); color:white; font-family:inherit; font-size:17px; font-weight:500; cursor:pointer; -webkit-tap-highlight-color:transparent; transition:all .15s; }
  #btn-new:active { transform:scale(.96); background:#9a5508; }
  .nb-item { display:flex; align-items:center; gap:12px; padding:14px; border-radius:10px; border:1.5px solid var(--border); background:var(--surface); margin-bottom:10px; cursor:pointer; transition:all .15s; -webkit-tap-highlight-color:transparent; }
  .nb-item:active { transform:scale(.98); border-color:var(--accent); }
  .nb-title { font-size:17px; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .nb-title.empty { color:var(--text-muted); font-style:italic; }
  .nb-sub { font-size:12px; color:var(--text-muted); margin-top:2px; }
  .list-empty { text-align:center; color:var(--text-muted); padding:60px 20px; font-size:15px; line-height:2; }

  /* ç·¨é›†ç”»é¢ */
  #memo-body { flex:1; overflow-y:auto; padding:12px; }
  #edit-footer { flex-shrink:0; background:var(--surface); border-top:1px solid var(--border); padding:10px 16px; display:flex; align-items:center; justify-content:space-between; }
  .fi-group { display:flex; flex-direction:column; align-items:center; gap:2px; }
  .fi-btns { display:flex; gap:6px; }
  .fi-label { font-size:11px; color:var(--text-muted); }
  .tbtn { width:48px; height:48px; border-radius:10px; border:1.5px solid var(--border); background:var(--bg); color:var(--text); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; -webkit-tap-highlight-color:transparent; }
  .tbtn:active { background:var(--accent); color:white; border-color:var(--accent); transform:scale(.93); }
  .tbtn:disabled { opacity:.3; cursor:default; }
  .tbtn.pri { background:var(--accent); color:white; border-color:var(--accent); font-size:22px; font-weight:bold; }

  /* ===== è¡Œ ===== */
  .line-wrap { position:relative; }
  .line-wrap.hidden { display:none; }
  .line-row {
    display:flex; align-items:flex-start; min-height:var(--row-h);
    border-radius:6px; transition:background .1s; position:relative;
    animation:fadeIn .13s ease;
  }
  .line-row[data-indent="1"] { padding-left:28px; }
  .line-row[data-indent="2"] { padding-left:56px; }
  .line-row.sel, .line-row:focus-within { background:rgba(184,101,10,.07); }
  .line-row.drag-over { background:rgba(184,101,10,.12); }
  .line-row[data-indent="1"]::before { content:''; position:absolute; left:14px; top:0; bottom:0; width:2px; background:var(--border); opacity:.4; border-radius:2px; }
  .line-row[data-indent="2"]::before { content:''; position:absolute; left:42px; top:0; bottom:0; width:2px; background:var(--border); opacity:.4; border-radius:2px; }

  /* ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« */
  .drag-handle {
    flex-shrink:0; width:24px; height:var(--row-h);
    display:flex; align-items:center; justify-content:center;
    color:var(--border); font-size:14px; cursor:grab;
    touch-action:none; user-select:none;
    -webkit-tap-highlight-color:transparent;
    transition:color .15s;
  }
  .drag-handle:hover { color:var(--text-muted); }
  .drag-handle:active { cursor:grabbing; color:var(--accent); }

  /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
  .drop-indicator {
    height:3px; background:var(--accent); border-radius:2px;
    margin:0 8px; display:none; pointer-events:none;
  }
  .drop-indicator.visible { display:block; }

  /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¡Œã‚°ãƒ«ãƒ¼ãƒ— */
  .line-wrap.dragging { opacity:.4; }

  /* ã‚´ãƒ¼ã‚¹ãƒˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æµ®ã„ã¦ã‚‹è¦ç´ ï¼‰ */
  #drag-ghost {
    position:fixed; pointer-events:none; z-index:9999;
    background:var(--surface); border:1.5px solid var(--accent);
    border-radius:8px; padding:8px 12px;
    font-family:'Noto Sans JP',sans-serif; font-size:var(--font-size);
    font-weight:300; color:var(--text);
    box-shadow:0 6px 24px rgba(0,0,0,.18);
    max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    display:none; transform:rotate(1.5deg);
  }

  .li-icon { flex-shrink:0; width:28px; height:var(--row-h); display:flex; align-items:center; justify-content:center; font-size:16px; color:var(--bullet); user-select:none; }
  .tog-btn { flex-shrink:0; width:28px; height:var(--row-h); display:flex; align-items:center; justify-content:center; font-size:13px; color:var(--accent); background:transparent; border:none; cursor:pointer; border-radius:6px; -webkit-tap-highlight-color:transparent; }
  .tog-btn:active { transform:scale(.88); }
  .li-input { flex:1; background:transparent; border:none; outline:none; font-family:inherit; font-size:var(--font-size); font-weight:300; color:var(--text); line-height:1.5; padding:10px 8px 10px 2px; caret-color:var(--accent); resize:none; overflow:hidden; min-height:var(--row-h); }
  .li-input::placeholder { color:var(--border); }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-3px)} to{opacity:1;transform:translateY(0)} }

  /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ */
  #drawer-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:200; }
  #drawer-overlay.open { display:block; }
  #drawer { position:fixed; top:0; right:-280px; width:260px; height:100%; background:var(--surface); border-left:1px solid var(--border); z-index:201; transition:right .25s ease; display:flex; flex-direction:column; }
  #drawer.open { right:0; }
  .drw-hdr { padding:16px 16px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .drw-hdr h2 { font-size:15px; font-weight:500; color:var(--text-muted); }
  #drw-close { width:30px; height:30px; border:none; background:transparent; color:var(--text-muted); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; border-radius:6px; }
  #drw-close:hover { background:var(--border); }
  .drw-sec { padding:16px; border-bottom:1px solid var(--border); }
  .drw-sec-title { font-size:11px; font-weight:500; color:var(--text-muted); letter-spacing:.08em; text-transform:uppercase; margin-bottom:12px; }
  .fs-opts { display:flex; flex-direction:column; gap:6px; }
  .fs-opt { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:8px; border:1.5px solid var(--border); background:var(--bg); cursor:pointer; transition:all .15s; -webkit-tap-highlight-color:transparent; }
  .fs-opt:hover { border-color:var(--accent); }
  .fs-opt.active { border-color:var(--accent); background:rgba(184,101,10,.1); color:var(--accent); }
  .fs-opt .lbl { font-size:12px; color:var(--text-muted); flex:1; }
  .fs-opt.active .lbl { color:var(--accent); }
  .fs-opt .chk { width:16px; font-size:14px; color:var(--accent); opacity:0; }
  .fs-opt.active .chk { opacity:1; }

  /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
  #conf-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:300; align-items:center; justify-content:center; }
  #conf-overlay.open { display:flex; }
  #conf-box { background:var(--surface); border-radius:14px; padding:24px 20px 16px; width:280px; box-shadow:0 8px 32px rgba(0,0,0,.18); display:flex; flex-direction:column; gap:16px; }
  #conf-box p { font-size:15px; text-align:center; line-height:1.5; }
  .conf-btns { display:flex; gap:10px; }
  .conf-btns button { flex:1; height:44px; border-radius:10px; border:1.5px solid var(--border); font-family:inherit; font-size:15px; cursor:pointer; }
  #conf-cancel { background:var(--bg); color:var(--text-muted); }
  #conf-ok { background:#c0392b; color:white; border-color:#c0392b; font-weight:500; }

  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
</style>
</head>
<body>

<!-- ç”»é¢A: ä¸€è¦§ -->
<div id="screen-list" class="screen active">
  <header class="hdr">
    <div class="hdr-left">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-muted)"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      <h1>ãƒ¡ãƒ¢ä¸€è¦§</h1>
    </div>
  </header>
  <div id="list-body"></div>
  <div id="list-footer">
    <button id="btn-new">ï¼‹ã€€æ–°ã—ã„ãƒ¡ãƒ¢</button>
  </div>
</div>

<!-- ç”»é¢B: ç·¨é›† -->
<div id="screen-edit" class="screen">
  <header class="hdr">
    <div class="hdr-left">
      <button class="icon-btn" id="btn-back">â†</button>
      <h1 id="edit-title">ãƒ¡ãƒ¢</h1>
    </div>
    <button class="icon-btn" id="btn-menu">â˜°</button>
  </header>
  <div id="memo-body"></div>
  <div id="edit-footer">
    <div class="fi-group">
      <div class="fi-btns">
        <button class="tbtn" id="btn-out">â†</button>
        <button class="tbtn" id="btn-in">â†’</button>
      </div>
      <span class="fi-label">ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ</span>
    </div>
    <button class="tbtn pri" id="btn-add">ï¼‹</button>
    <button class="tbtn" id="btn-del" style="font-size:18px">ğŸ—‘</button>
    <button class="tbtn" id="btn-clr" style="font-size:15px">å…¨æ¶ˆ</button>
  </div>
</div>

<!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
<div id="drawer-overlay"></div>
<div id="drawer">
  <div class="drw-hdr"><h2>è¨­å®š</h2><button id="drw-close">âœ•</button></div>
  <div class="drw-sec">
    <div class="drw-sec-title">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º</div>
    <div class="fs-opts" id="fs-opts">
      <button class="fs-opt" data-size="13"><span style="font-size:13px;font-weight:300">ã‚Aa</span><span class="lbl">å° (13px)</span><span class="chk">âœ“</span></button>
      <button class="fs-opt" data-size="15"><span style="font-size:15px;font-weight:300">ã‚Aa</span><span class="lbl">ä¸­ (15px)</span><span class="chk">âœ“</span></button>
      <button class="fs-opt" data-size="17"><span style="font-size:17px;font-weight:300">ã‚Aa</span><span class="lbl">æ¨™æº– (17px)</span><span class="chk">âœ“</span></button>
      <button class="fs-opt" data-size="20"><span style="font-size:20px;font-weight:300">ã‚Aa</span><span class="lbl">å¤§ (20px)</span><span class="chk">âœ“</span></button>
      <button class="fs-opt active" data-size="24"><span style="font-size:24px;font-weight:300">ã‚Aa</span><span class="lbl">ç‰¹å¤§ (24px)</span><span class="chk">âœ“</span></button>
    </div>
  </div>
</div>

<!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="conf-overlay">
  <div id="conf-box">
    <p>ã“ã®ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="conf-btns">
      <button id="conf-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="conf-ok">å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- DnDã‚´ãƒ¼ã‚¹ãƒˆ -->
<div id="drag-ghost"></div>

<script>
// ================================================================
// çŠ¶æ…‹
// ================================================================
const NB_KEY   = 'kaisou-nb-v1';
const FONT_KEY = 'kaisou-font-v1';
const FS_LIST  = [13,15,17,20,24];

let notebooks  = [];
let nbNextId   = 1;
let curNbId    = null;
let lines      = [];
let lineNextId = 1;
let selId      = null;
let fontSize   = 24;

// ================================================================
// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
// ================================================================
function persist() {
  if (curNbId !== null) {
    const nb = notebooks.find(n=>n.id===curNbId);
    if (nb) { nb.lines=lines; nb.lineNextId=lineNextId; }
  }
  try { localStorage.setItem(NB_KEY, JSON.stringify({notebooks,nbNextId})); } catch(e){}
}

function loadData() {
  try {
    const d = JSON.parse(localStorage.getItem(NB_KEY)||'null');
    if (d && Array.isArray(d.notebooks) && d.notebooks.length>0) {
      notebooks = d.notebooks.map(nb=>({
        id:nb.id, lineNextId:nb.lineNextId||2,
        lines:(nb.lines||[]).map(l=>({id:l.id,text:l.text||'',indent:l.indent||0,collapsed:!!l.collapsed}))
      }));
      nbNextId = d.nbNextId || Math.max(...notebooks.map(n=>n.id))+1;
      return;
    }
  } catch(e){}
  notebooks=[]; nbNextId=1;
}

function loadFont() {
  try { const s=parseInt(localStorage.getItem(FONT_KEY),10); if(FS_LIST.includes(s)) fontSize=s; } catch(e){}
}

function applyFont(size) {
  fontSize=size;
  document.documentElement.style.setProperty('--font-size',size+'px');
  document.querySelectorAll('.fs-opt').forEach(el=>el.classList.toggle('active',parseInt(el.dataset.size,10)===size));
  autoResize();
  try { localStorage.setItem(FONT_KEY,size); } catch(e){}
}

// ================================================================
// ç”»é¢åˆ‡æ›¿
// ================================================================
function showList() {
  persist(); curNbId=null;
  document.getElementById('screen-list').classList.add('active');
  document.getElementById('screen-edit').classList.remove('active');
  renderList();
}

function showEdit() {
  document.getElementById('screen-list').classList.remove('active');
  document.getElementById('screen-edit').classList.add('active');
}

// ================================================================
// ä¸€è¦§
// ================================================================
function nbTitle(nb) {
  if (!nb.lines||nb.lines.length===0) return null;
  const f=nb.lines.find(l=>l.text.trim());
  return f?f.text.trim():null;
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderList() {
  const el=document.getElementById('list-body');
  el.innerHTML='';
  if (notebooks.length===0) {
    el.innerHTML='<div class="list-empty">ã€Œï¼‹ æ–°ã—ã„ãƒ¡ãƒ¢ã€ã‹ã‚‰ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    return;
  }
  notebooks.forEach(nb=>{
    const title=nbTitle(nb);
    const cnt=(nb.lines||[]).filter(l=>l.text.trim()).length;
    const div=document.createElement('div');
    div.className='nb-item';
    div.innerHTML=`<div style="font-size:20px;color:var(--text-muted)">ğŸ“„</div><div style="flex:1;min-width:0"><div class="nb-title ${title?'':'empty'}">${title?esc(title):'ï¼ˆç„¡é¡Œï¼‰'}</div><div class="nb-sub">${cnt} è¡Œ</div></div><div style="color:var(--border);font-size:18px">â€º</div>`;
    div.addEventListener('click',()=>openNb(nb.id));
    el.appendChild(div);
  });
}

function newNb() {
  const nb={id:nbNextId++,lineNextId:2,lines:[{id:1,text:'',indent:0,collapsed:false}]};
  notebooks.push(nb); persist(); openNb(nb.id);
}

function openNb(id) {
  const nb=notebooks.find(n=>n.id===id); if(!nb) return;
  curNbId=id;
  lines=nb.lines.length>0?nb.lines:[{id:1,text:'',indent:0,collapsed:false}];
  lineNextId=nb.lineNextId||Math.max(...lines.map(l=>l.id))+1;
  selId=null;
  document.getElementById('edit-title').textContent=nbTitle(nb)||'ãƒ¡ãƒ¢';
  showEdit(); renderMemo();
  requestAnimationFrame(()=>{ if(lines.length) focusLine(lines[0].id); });
}

// ================================================================
// ãƒ¡ãƒ¢ç·¨é›†
// ================================================================
function hasKids(idx) { return idx>=0&&idx<lines.length-1&&lines[idx+1].indent>lines[idx].indent; }

function hiddenIds() {
  const h=new Set();
  for(let i=0;i<lines.length;i++) {
    if(lines[i].collapsed&&hasKids(i)) {
      for(let j=i+1;j<lines.length;j++) { if(lines[j].indent>lines[i].indent) h.add(lines[j].id); else break; }
    }
  }
  return h;
}

// idxç•ªã®è¡Œã®ã€Œã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆè‡ªèº«ï¼‹ã™ã¹ã¦ã®å­å­«ï¼‰ã€ã®æœ«å°¾ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
function groupEnd(idx) {
  const baseIndent = lines[idx].indent;
  let end = idx;
  for (let j=idx+1; j<lines.length; j++) {
    if (lines[j].indent > baseIndent) end=j;
    else break;
  }
  return end;
}

function renderMemo() {
  const c=document.getElementById('memo-body');
  c.innerHTML='';
  const hidden=hiddenIds();

  // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆæœ€ä¸Šéƒ¨ç”¨ï¼‰
  c.appendChild(makeIndicator(-1));

  for(let idx=0;idx<lines.length;idx++) {
    const line=lines[idx];
    const kids=hasKids(idx);

    const wrap=document.createElement('div');
    wrap.className='line-wrap';
    wrap.dataset.idx=String(idx);
    if(hidden.has(line.id)) wrap.classList.add('hidden');

    const row=document.createElement('div');
    row.className='line-row';
    row.dataset.id=String(line.id);
    row.dataset.indent=String(line.indent);
    if(line.id===selId) row.classList.add('sel');

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«
    const handle=document.createElement('div');
    handle.className='drag-handle';
    handle.textContent='â ¿';
    handle.title='ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•';
    attachDragHandle(handle, idx);
    row.appendChild(handle);

    // â–½/â–· or ãƒ»
    if(kids) {
      const btn=document.createElement('button');
      btn.className='tog-btn'; btn.textContent=line.collapsed?'â–·':'â–½';
      btn.addEventListener('click',e=>{ e.stopPropagation(); line.collapsed=!line.collapsed; persist(); renderMemo(); focusLine(line.id); });
      row.appendChild(btn);
    } else {
      const icon=document.createElement('div');
      icon.className='li-icon'; icon.textContent='â€¢';
      row.appendChild(icon);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
    const ta=document.createElement('textarea');
    ta.className='li-input'; ta.value=line.text; ta.rows=1;
    if(idx===0) ta.placeholder='ãƒ¡ãƒ¢ã‚’å…¥åŠ›...';
    ta.addEventListener('input',()=>{
      ta.style.height='auto'; ta.style.height=ta.scrollHeight+'px';
      line.text=ta.value;
      document.getElementById('edit-title').textContent=nbTitle(notebooks.find(n=>n.id===curNbId)||{lines})||'ãƒ¡ãƒ¢';
      persist();
    });
    ta.addEventListener('focus',()=>{
      selId=line.id;
      document.querySelectorAll('.line-row.sel').forEach(el=>el.classList.remove('sel'));
      row.classList.add('sel'); updBtns();
    });
    ta.addEventListener('keydown',e=>onKey(e,line));
    row.appendChild(ta);
    wrap.appendChild(row);
    c.appendChild(wrap);

    // å„è¡Œã®ä¸‹ã«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    c.appendChild(makeIndicator(idx));
  }

  updBtns();
  requestAnimationFrame(autoResize);
}

function makeIndicator(afterIdx) {
  const el=document.createElement('div');
  el.className='drop-indicator';
  el.dataset.afterIdx=String(afterIdx);
  return el;
}

function autoResize() {
  document.querySelectorAll('.li-input').forEach(ta=>{ ta.style.height='auto'; ta.style.height=ta.scrollHeight+'px'; });
}

function focusLine(id) {
  selId=id;
  requestAnimationFrame(()=>{
    const ta=document.querySelector(`.line-row[data-id="${id}"] .li-input`);
    if(ta){ ta.focus(); ta.setSelectionRange(ta.value.length,ta.value.length); ta.style.height='auto'; ta.style.height=ta.scrollHeight+'px'; }
    updBtns();
  });
}

function onKey(e,line) {
  if(e.key==='Enter'&&!e.shiftKey) {
    e.preventDefault();
    const idx=lines.findIndex(l=>l.id===line.id);
    const nl={id:lineNextId++,text:'',indent:line.indent,collapsed:false};
    lines.splice(idx+1,0,nl); persist(); renderMemo(); focusLine(nl.id);
  } else if(e.key==='Backspace'&&line.text==='') {
    e.preventDefault();
    if(line.indent>0) { line.indent--; persist(); renderMemo(); focusLine(line.id); }
    else {
      const idx=lines.findIndex(l=>l.id===line.id);
      if(lines.length>1) { lines.splice(idx,1); persist(); renderMemo(); focusLine(lines[Math.max(0,idx-1)].id); }
    }
  }
}

function getSel() { return lines.find(l=>l.id===selId)||null; }
function updBtns() {
  const l=getSel();
  document.getElementById('btn-in').disabled=!l||l.indent>=2;
  document.getElementById('btn-out').disabled=!l||l.indent<=0;
}

// ================================================================
// ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
// ================================================================
let dnd = {
  active: false,
  srcIdx: -1,       // ãƒ‰ãƒ©ãƒƒã‚°å…ƒã®è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  groupLen: 0,      // ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®è¡Œæ•°
  curAfterIdx: null // ç¾åœ¨ã®ãƒ‰ãƒ­ãƒƒãƒ—å…ˆï¼ˆã“ã®è¡Œã®å¾Œã«æŒ¿å…¥ï¼‰
};

const ghost = document.getElementById('drag-ghost');

function attachDragHandle(handle, idx) {
  // ã‚¿ãƒƒãƒ
  handle.addEventListener('touchstart', e=>startDrag(e, idx, e.touches[0].clientX, e.touches[0].clientY), {passive:false});
  // ãƒã‚¦ã‚¹
  handle.addEventListener('mousedown', e=>{ if(e.button===0) startDrag(e, idx, e.clientX, e.clientY); });
}

function startDrag(e, idx, clientX, clientY) {
  e.preventDefault();
  const end = groupEnd(idx);
  dnd.active   = true;
  dnd.srcIdx   = idx;
  dnd.groupLen = end - idx + 1;
  dnd.curAfterIdx = null;

  // ã‚´ãƒ¼ã‚¹ãƒˆã«ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
  ghost.textContent = lines[idx].text || 'ï¼ˆç©ºè¡Œï¼‰';
  ghost.style.display = 'block';
  moveGhost(clientX, clientY);

  // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¡Œã‚°ãƒ«ãƒ¼ãƒ—ã‚’åŠé€æ˜ã«
  const wraps = document.querySelectorAll('.line-wrap');
  for (let i=idx; i<=end; i++) {
    if (wraps[i]) wraps[i].classList.add('dragging');  // wrapã¯idxé †ã§ã¯ãªã„ã®ã§åˆ¥é€”å¯¾å¿œ
  }
  // data-idx ã§å¼•ãç›´ã™
  document.querySelectorAll('.line-wrap[data-idx]').forEach(w=>{
    const wi=parseInt(w.dataset.idx,10);
    if(wi>=idx&&wi<=end) w.classList.add('dragging');
  });

  if (e.type==='touchstart') {
    document.addEventListener('touchmove', onDragMove, {passive:false});
    document.addEventListener('touchend', onDragEnd, {once:true});
  } else {
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd, {once:true});
  }
}

function onDragMove(e) {
  const cx = e.touches ? e.touches[0].clientX : e.clientX;
  const cy = e.touches ? e.touches[0].clientY : e.clientY;
  moveGhost(cx, cy);
  updateDropTarget(cy);
}

function moveGhost(cx, cy) {
  ghost.style.left = (cx+12)+'px';
  ghost.style.top  = (cy-16)+'px';
}

function updateDropTarget(cy) {
  // å…¨ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
  document.querySelectorAll('.drop-indicator').forEach(el=>el.classList.remove('visible'));

  // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã‚’æ¢ã™ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å…ƒã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãï¼‰
  const srcIdx  = dnd.srcIdx;
  const srcEnd  = srcIdx + dnd.groupLen - 1;
  const indicators = document.querySelectorAll('.drop-indicator');
  let best = null, bestDist = Infinity;

  indicators.forEach(ind=>{
    const afterIdx = parseInt(ind.dataset.afterIdx, 10);
    // ãƒ‰ãƒ©ãƒƒã‚°å…ƒã‚°ãƒ«ãƒ¼ãƒ—ã®ç¯„å›²å†…ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯é™¤å¤–
    // afterIdx ãŒ srcIdx-1 ã€œ srcEnd ã®é–“ã¯ã‚¹ã‚­ãƒƒãƒ—
    if (afterIdx >= srcIdx-1 && afterIdx <= srcEnd) return;
    const rect = ind.getBoundingClientRect();
    const midY = rect.top + rect.height/2;
    const dist = Math.abs(cy - midY);
    if (dist < bestDist) { bestDist=dist; best=ind; }
  });

  if (best && bestDist < 60) {
    best.classList.add('visible');
    dnd.curAfterIdx = parseInt(best.dataset.afterIdx, 10);
  } else {
    dnd.curAfterIdx = null;
  }
}

function onDragEnd() {
  document.removeEventListener('mousemove', onDragMove);
  document.removeEventListener('touchmove', onDragMove);

  ghost.style.display='none';
  document.querySelectorAll('.drop-indicator').forEach(el=>el.classList.remove('visible'));
  document.querySelectorAll('.line-wrap.dragging').forEach(el=>el.classList.remove('dragging'));

  if (dnd.active && dnd.curAfterIdx !== null) {
    applyDrop(dnd.srcIdx, dnd.groupLen, dnd.curAfterIdx);
  }

  dnd.active=false; dnd.srcIdx=-1; dnd.groupLen=0; dnd.curAfterIdx=null;
}

// ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã‚’ srcIdx ã‹ã‚‰å–ã‚Šå‡ºã—ã¦ afterIdx ã®å¾Œã‚ã«æŒ¿å…¥
function applyDrop(srcIdx, groupLen, afterIdx) {
  // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–ã‚Šå‡ºã™
  const group = lines.splice(srcIdx, groupLen);

  // å–ã‚Šå‡ºã—ãŸå¾Œã® afterIdx ã‚’è£œæ­£
  // srcIdx ã‚ˆã‚Šå‰ã«æŒ¿å…¥ãªã‚‰ afterIdx ã¯ãã®ã¾ã¾
  // srcIdx ã‚ˆã‚Šå¾Œã«æŒ¿å…¥ãªã‚‰ afterIdx ã‚’ groupLen åˆ†ç¸®ã‚ã‚‹
  let insertAfter = afterIdx;
  if (afterIdx >= srcIdx) {
    insertAfter = afterIdx - groupLen;
  }

  // insertAfter+1 ã®ä½ç½®ã«æŒ¿å…¥ï¼ˆ-1ãªã‚‰å…ˆé ­ï¼‰
  const insertAt = insertAfter + 1;
  lines.splice(insertAt, 0, ...group);

  persist();
  renderMemo();
}

// ================================================================
// ã‚¤ãƒ™ãƒ³ãƒˆ
// ================================================================
document.getElementById('btn-new').addEventListener('click', newNb);
document.getElementById('btn-back').addEventListener('click', showList);
document.getElementById('btn-in').addEventListener('click', ()=>{ const l=getSel(); if(!l||l.indent>=2) return; l.indent++; persist(); renderMemo(); focusLine(l.id); });
document.getElementById('btn-out').addEventListener('click', ()=>{ const l=getSel(); if(!l||l.indent<=0) return; l.indent--; persist(); renderMemo(); focusLine(l.id); });
document.getElementById('btn-add').addEventListener('click', ()=>{ const l=getSel(); const idx=l?lines.findIndex(x=>x.id===l.id):lines.length-1; const ind=l?l.indent:0; const nl={id:lineNextId++,text:'',indent:ind,collapsed:false}; lines.splice(idx+1,0,nl); persist(); renderMemo(); focusLine(nl.id); });
document.getElementById('btn-del').addEventListener('click', ()=>{ const l=getSel(); if(!l) return; if(lines.length<=1){lines[0].text='';persist();renderMemo();focusLine(lines[0].id);return;} const idx=lines.findIndex(x=>x.id===l.id); lines.splice(idx,1); persist(); renderMemo(); focusLine(lines[Math.max(0,idx-1)].id); });
document.getElementById('btn-clr').addEventListener('click', ()=>{ document.getElementById('conf-overlay').classList.add('open'); });
document.getElementById('memo-body').addEventListener('click', e=>{ if(e.target===e.currentTarget&&lines.length) focusLine(lines[lines.length-1].id); });
document.getElementById('btn-menu').addEventListener('click', ()=>{ document.getElementById('drawer').classList.add('open'); document.getElementById('drawer-overlay').classList.add('open'); });
document.getElementById('drw-close').addEventListener('click', ()=>{ document.getElementById('drawer').classList.remove('open'); document.getElementById('drawer-overlay').classList.remove('open'); });
document.getElementById('drawer-overlay').addEventListener('click', ()=>{ document.getElementById('drawer').classList.remove('open'); document.getElementById('drawer-overlay').classList.remove('open'); });
document.getElementById('fs-opts').addEventListener('click', e=>{ const opt=e.target.closest('.fs-opt'); if(!opt) return; const s=parseInt(opt.dataset.size,10); if(!isNaN(s)) applyFont(s); });
document.getElementById('conf-cancel').addEventListener('click', ()=>{ document.getElementById('conf-overlay').classList.remove('open'); });
document.getElementById('conf-ok').addEventListener('click', ()=>{ document.getElementById('conf-overlay').classList.remove('open'); lineNextId=2; lines=[{id:1,text:'',indent:0,collapsed:false}]; selId=null; persist(); renderMemo(); focusLine(lines[0].id); });

// ================================================================
// èµ·å‹•
// ================================================================
loadFont(); loadData(); applyFont(fontSize); renderList();
</script>
</body>
</html>
